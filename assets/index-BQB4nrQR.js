import{f as O,q as _,a as R,b as $,c as M}from"./index-30lG7wjF.js";const C=(e,o)=>({...e,getList:async function(a,i){let t=i;t=await s({name:"beforeGetList",params:t,dataProvider:e,handlers:o,resource:a});let n=await e.getList(a,t);return n=await s({name:"afterGetList",params:n,dataProvider:e,handlers:o,resource:a}),n.data=await Promise.all(n.data.map(l=>s({name:"afterRead",params:l,dataProvider:e,handlers:o,resource:a}))),n},getOne:async function(a,i){let t=i;t=await s({name:"beforeGetOne",params:t,dataProvider:e,handlers:o,resource:a});let n=await e.getOne(a,t);return n=await s({name:"afterGetOne",params:n,dataProvider:e,handlers:o,resource:a}),n.data=await s({name:"afterRead",params:n.data,dataProvider:e,handlers:o,resource:a}),n},getMany:async function(a,i){let t=i;t=await s({name:"beforeGetMany",params:t,dataProvider:e,handlers:o,resource:a});let n=await e.getMany(a,t);return n=await s({name:"afterGetMany",params:n,dataProvider:e,handlers:o,resource:a}),n.data=await Promise.all(n.data.map(l=>s({name:"afterRead",params:l,dataProvider:e,handlers:o,resource:a}))),n},getManyReference:async function(a,i){let t=i;t=await s({name:"beforeGetManyReference",params:t,dataProvider:e,handlers:o,resource:a});let n=await e.getManyReference(a,t);return n=await s({name:"afterGetManyReference",params:n,dataProvider:e,handlers:o,resource:a}),n.data=await Promise.all(n.data.map(l=>s({name:"afterRead",params:l,dataProvider:e,handlers:o,resource:a}))),n},update:async function(a,i){let t=i;t=await s({name:"beforeUpdate",params:t,dataProvider:e,handlers:o,resource:a}),t.data=await s({name:"beforeSave",params:t.data,dataProvider:e,handlers:o,resource:a});let n=await e.update(a,t);return n=await s({name:"afterUpdate",params:n,dataProvider:e,handlers:o,resource:a}),n.data=await s({name:"afterSave",params:n.data,dataProvider:e,handlers:o,resource:a}),n},create:async function(a,i){let t=i;t=await s({name:"beforeCreate",params:t,dataProvider:e,handlers:o,resource:a}),t.data=await s({name:"beforeSave",params:t.data,dataProvider:e,handlers:o,resource:a});let n=await e.create(a,t);return n=await s({name:"afterCreate",params:n,dataProvider:e,handlers:o,resource:a}),n.data=await s({name:"afterSave",params:n.data,dataProvider:e,handlers:o,resource:a}),n},delete:async function(a,i){let t=i;t=await s({name:"beforeDelete",params:t,dataProvider:e,handlers:o,resource:a});let n=await e.delete(a,t);return n=await s({name:"afterDelete",params:n,dataProvider:e,handlers:o,resource:a}),n},updateMany:async function(a,i){let t=i;t=await s({name:"beforeUpdateMany",params:t,dataProvider:e,handlers:o,resource:a}),t.data=await s({name:"beforeSave",params:t.data,dataProvider:e,handlers:o,resource:a});let n=await e.updateMany(a,t);if(n=await s({name:"afterUpdateMany",params:n,dataProvider:e,handlers:o,resource:a}),o.filter(c=>(c.resource===a||c.resource==="*")&&c.afterSave).length>0){const{data:c}=await e.getMany(a,{ids:n.data});await Promise.all(c.map(r=>s({name:"afterSave",params:r,dataProvider:e,handlers:o,resource:a})))}return n},deleteMany:async function(a,i){let t=i;t=await s({name:"beforeDeleteMany",params:t,dataProvider:e,handlers:o,resource:a});let n=await e.deleteMany(a,t);return n=await s({name:"afterDeleteMany",params:n,dataProvider:e,handlers:o,resource:a}),n}}),s=async function({name:e,params:o,dataProvider:a,handlers:i,resource:t}){let n=o;const l=i.filter(c=>(c.resource===t||c.resource==="*")&&c[e]);for(let c of l){const r=c[e];if(Array.isArray(r))for(let d of r??[])n=await d(n,a,t);else n=await r(n,a,t)}return n},I=(e,o=O,a="Content-Range")=>({getList:(i,t)=>{const{page:n,perPage:l}=t.pagination||{page:1,perPage:10},{field:c,order:r}=t.sort||{field:"id",order:"ASC"},d=(n-1)*l,f=n*l-1,u={sort:JSON.stringify([c,r]),range:JSON.stringify([d,f]),filter:JSON.stringify(t.filter)},p=`${e}/${i}?${_.stringify(u)}`,y=a==="Content-Range"?{headers:new Headers({Range:`${i}=${d}-${f}`}),signal:t==null?void 0:t.signal}:{signal:t==null?void 0:t.signal};return o(p,y).then(({headers:m,json:b})=>{if(!m.has(a))throw new Error(`The ${a} header is missing in the HTTP Response. The simple REST data provider expects responses for lists of resources to contain this header with the total number of results to build the pagination. If you are using CORS, did you declare ${a} in the Access-Control-Expose-Headers header?`);return{data:b,total:a==="Content-Range"?parseInt(m.get("content-range").split("/").pop()||"",10):parseInt(m.get(a.toLowerCase()))}})},getOne:(i,t)=>o(`${e}/${i}/${encodeURIComponent(t.id)}`,{signal:t==null?void 0:t.signal}).then(({json:n})=>({data:n})),getMany:(i,t)=>{const n={filter:JSON.stringify({id:t.ids})},l=`${e}/${i}?${_.stringify(n)}`;return o(l,{signal:t==null?void 0:t.signal}).then(({json:c})=>({data:c}))},getManyReference:(i,t)=>{const{page:n,perPage:l}=t.pagination,{field:c,order:r}=t.sort,d=(n-1)*l,f=n*l-1,u={sort:JSON.stringify([c,r]),range:JSON.stringify([(n-1)*l,n*l-1]),filter:JSON.stringify({...t.filter,[t.target]:t.id})},p=`${e}/${i}?${_.stringify(u)}`,y=a==="Content-Range"?{headers:new Headers({Range:`${i}=${d}-${f}`}),signal:t==null?void 0:t.signal}:{signal:t==null?void 0:t.signal};return o(p,y).then(({headers:m,json:b})=>{if(!m.has(a))throw new Error(`The ${a} header is missing in the HTTP Response. The simple REST data provider expects responses for lists of resources to contain this header with the total number of results to build the pagination. If you are using CORS, did you declare ${a} in the Access-Control-Expose-Headers header?`);return{data:b,total:a==="Content-Range"?parseInt(m.get("content-range").split("/").pop()||"",10):parseInt(m.get(a.toLowerCase()))}})},update:(i,t)=>o(`${e}/${i}/${encodeURIComponent(t.id)}`,{method:"PUT",body:JSON.stringify(t.data)}).then(({json:n})=>({data:n})),updateMany:(i,t)=>Promise.all(t.ids.map(n=>o(`${e}/${i}/${encodeURIComponent(n)}`,{method:"PUT",body:JSON.stringify(t.data)}))).then(n=>({data:n.map(({json:l})=>l.id)})),create:(i,t)=>o(`${e}/${i}`,{method:"POST",body:JSON.stringify(t.data)}).then(({json:n})=>({data:n})),delete:(i,t)=>o(`${e}/${i}/${encodeURIComponent(t.id)}`,{method:"DELETE",headers:new Headers({"Content-Type":"text/plain"})}).then(({json:n})=>({data:n})),deleteMany:(i,t)=>Promise.all(t.ids.map(n=>o(`${e}/${i}/${encodeURIComponent(n)}`,{method:"DELETE",headers:new Headers({"Content-Type":"text/plain"})}))).then(n=>({data:n.map(({json:l})=>l.id)}))}),w="user",S={id:1,email:"janedoe@atomic.dev",password:"demo"},g=()=>{const e=localStorage.getItem(w);return e?JSON.parse(e):null},E=I("https://fake-atomic-pm.com"),T=R($(E)),A=C({...T,subscribe:()=>Promise.resolve(),unsubscribe:()=>Promise.resolve(),moveColumn:async({data:e,previousData:o})=>{const a=window._database.collections.columns.getAll({filter:{position:{board_id:o.board_id,position_gt:o.position}},sort:["position","asc"],range:[0,1e3]});for(const i of a)window._database.collections.columns.updateOne(i.id,{...i,position:i.position-1});window._database.collections.columns.getAll({filter:{position:{board_id:o.board_id,position_gte:e.position}},sort:["position","asc"],range:[0,1e3]});for(const i of a)window._database.collections.columns.updateOne(i.id,{...i,position:i.position+1});window._database.collections.columns.updateOne(e.column_id,{position:e.position})},moveCard:async({data:e,previousData:o})=>{const a=window._database.collections.cards.getAll({filter:{position:{column_id:o.column_id,position_gt:o.position}},sort:["position","asc"],range:[0,1e3]});for(const n of a)window._database.collections.cards.updateOne(n.id,{...n,position:n.position-1});window._database.collections.columns.getAll({filter:{position:{column_id:o.column_id,position_gte:e.position}},sort:["position","asc"],range:[0,1e3]});for(const n of a)window._database.collections.columns.updateOne(n.id,{...n,position:n.position+1});window._database.collections.cards.updateOne(e.card_id,{column_id:e.column_id,position:e.position});const i=window._database.collections.columns.getOne(o.column_id),t=g();if(o.column_id!==e.column_id){const n=window._database.collections.columns.getOne(e.column_id);window._database.collections.card_events.addOne({card_id:e.card_id,user_id:t.id,date:new Date().toISOString(),type:"revision",message:`Moved card from column "${i.name}" to "${n.name}" at position ${e.position}`})}else window._database.collections.card_events.addOne({card_id:e.card_id,user_id:t.id,date:new Date().toISOString(),type:"revision",message:`Moved card to position ${e.position} `})},getDocumentUrl:async({data:e})=>{const o=localStorage.getItem(e.filePath);if(!o)return null;const[,a]=o.split(","),i=Uint8Array.from(atob(a),l=>l.charCodeAt(0)),t=new Blob([i]);return{data:URL.createObjectURL(t)}}},[{resource:"boards",afterGetOne:async e=>{const o=e.data,a=window._database.collections.columns.getAll({filter:{board_id:o.id},sort:["position","asc"],range:[0,1e3],embed:["cards"]});return{...e,data:{...o,columns:a}}},beforeGetList:e=>{const o=g();return Promise.resolve({...e,filter:{...e.filter,user_id:o.id}})}},{resource:"documents",beforeCreate:async({data:e,meta:o})=>{if(e.content instanceof File){const a=await new Promise(i=>{const t=new FileReader;t.onload=()=>{i(t.result)},t.readAsDataURL(e.content)});localStorage.setItem(e.content.name,a),e.type=e.content.type,e.content=e.content.name}return{data:e,meta:o}}},{resource:"comments",afterCreate:async({data:e,meta:o})=>{const a=g();return window._database.collections.card_events.addOne({card_id:e.card_id,user_id:a.id,date:new Date().toISOString(),type:"comment",message:e.message}),M.invalidateQueries({queryKey:["card_events","getManyReference"]}),{data:e,meta:o}}}]);localStorage.setItem(w,JSON.stringify({...S}));async function L(e){const o=await A.getList("profiles",{pagination:{page:1,perPage:200},sort:{field:"name",order:"ASC"}});if(!o.data.length)return{...S};const a=o.data.find(i=>i.email===e);return!a||a.disabled?{...S}:a}const U={login:async({email:e})=>{const o=await L(e);return localStorage.setItem(w,JSON.stringify(o)),Promise.resolve()},logout:()=>(localStorage.removeItem(w),Promise.resolve()),checkError:()=>Promise.resolve(),checkAuth:()=>g()?Promise.resolve():Promise.reject(),getIdentity:()=>{const e=g();return Promise.resolve({id:e.id,fullName:e.email})}};export{U as authProvider,A as dataProvider};
